{% extends 'base.html' %}

{% block title %}–ù–æ–≤–∏–π –ø–ª–∞–Ω{% endblock %}
{% block header %}‚ûï –ù–æ–≤–∏–π –ø–ª–∞–Ω –¥–ª—è –ø–æ–ª—è {{ field.name }}{% endblock %}

{% block content %}
<!-- –ö–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥ –∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è–º -->
<button type="button" class="btn btn-outline-secondary mb-3" id="back-button">
  ‚¨ÖÔ∏è –ù–∞–∑–∞–¥
</button>

<!-- –Ü–Ω—Ñ–æ –ø—Ä–æ –ø–æ–ª–µ -->
<div class="mb-3 d-flex gap-4">
  <div><strong>–ü–æ–ª–µ:</strong> {{ field.name }}</div>
  <div><strong>–ü–ª–æ—â–∞:</strong> {{ field.area }} –≥–∞</div>
  <div><strong>–ö—É–ª—å—Ç—É—Ä–∞:</strong> {{ field.culture.name if field.culture else '‚Äî' }}</div>
</div>

<form method="POST">
  {{ form.hidden_tag() }}

  <table class="table table-bordered text-center align-middle" id="treatments-table">
    <thead class="table-success">
      <tr>
        <th>–í–∏–¥ –æ–±—Ä–æ–±—ñ—Ç–∫—É</th>
        <th>–ü—Ä–æ–¥—É–∫—Ç</th>
        <th>–ù–æ—Ä–º–∞</th>
        <th>–í–∏—Ä–æ–±–Ω–∏–∫</th>
        <th>–û–¥–∏–Ω–∏—Ü—è</th>
        <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <!-- –°–ø–æ—á–∞—Ç–∫—É –ø–æ—Ä–æ–∂–Ω—è -->
    </tbody>
  </table>

  <div class="mb-3">
    <button type="button" class="btn btn-outline-info" id="add-treatment">‚ûï –î–æ–¥–∞—Ç–∏ –æ–±—Ä–æ–±—ñ—Ç–æ–∫</button>
  </div>

  <div class="text-end">
    {{ form.submit(class="btn btn-success") }}
  </div>
</form>

<!-- –®–∞–±–ª–æ–Ω —Ä—è–¥–∫–∞ -->
<template id="treatment-row-template">
  <tr>
    <td>
      <select name="treatments-__index__-treatment_type_id" class="form-select" required>
        <option value="" disabled selected>‚Äî –û–±–µ—Ä—ñ—Ç—å –≤–∏–¥ ‚Äî</option>
        {% for t in treatment_types %}
        <option value="{{ t.id }}">{{ t.name }}</option>
        {% endfor %}
      </select>
    </td>
    <td>
      <select name="treatments-__index__-product_id" class="form-select product-select" required>
        <option value="" disabled selected>‚Äî –û–±–µ—Ä—ñ—Ç—å –ø—Ä–æ–¥—É–∫—Ç ‚Äî</option>
        {% for p in products %}
        <option value="{{ p.id }}"
                data-manufacturer="{{ p.manufacturer.name if p.manufacturer else '' }}"
                data-unit="{{ p.unit.name if p.unit else '' }}">
          {{ p.name }}
        </option>
        {% endfor %}
      </select>
    </td>
    <td>
      <input type="number" name="treatments-__index__-rate" class="form-control rate-field" step="0.01" min="0" required>
    </td>
    <td>
      <input type="text" class="form-control unit-field" name="treatments-__index__-unit" readonly>
    </td>
    <td>
      <input type="text" class="form-control manufacturer-field" name="treatments-__index__-manufacturer" readonly>
    </td>
    <td>
      <input type="text" class="form-control quantity-field" name="treatments-__index__-quantity" readonly>
    </td>
    <td>
      <button type="button" class="btn btn-outline-danger btn-sm delete-row">üóëÔ∏è</button>
    </td>
  </tr>
</template>


<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤–∏—Ö–æ–¥—É -->
<div class="modal fade" id="confirmExitModal" tabindex="-1" aria-labelledby="confirmExitModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmExitModalLabel">–ó–±–µ—Ä–µ–≥—Ç–∏ –ø–ª–∞–Ω?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä–∏—Ç–∏"></button>
      </div>
      <div class="modal-body">
        –í–∏ —Ö–æ—á–µ—Ç–µ –∑–±–µ—Ä–µ–≥—Ç–∏ –ø–ª–∞–Ω –ø–µ—Ä–µ–¥ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è–º?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" id="exit-without-saving">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—å –¥–æ –≤–∏–±–æ—Ä—É –ø–æ–ª—è</button>
        <button type="button" class="btn btn-success" id="submit-plan">–ó–±–µ—Ä–µ–≥—Ç–∏ –ø–ª–∞–Ω</button>
      </div>
    </div>
  </div>
</div>


<!-- JavaScript -->
<script>
  let treatmentIndex = 0;

  document.getElementById('add-treatment').addEventListener('click', function () {
    const tableBody = document.querySelector('#treatments-table tbody');
    const template = document.getElementById('treatment-row-template').innerHTML;
    const rowHtml = template.replace(/__index__/g, treatmentIndex);
    const tempDiv = document.createElement('tbody');
    tempDiv.innerHTML = rowHtml;
    const newRow = tempDiv.firstElementChild;
    tableBody.appendChild(newRow);
    treatmentIndex++;

    // –ü–æ–ª—è –∑ –Ω–æ–≤–æ–≥–æ —Ä—è–¥–∫–∞
    const productSelect = newRow.querySelector('.product-select');
    const manufacturerInput = newRow.querySelector('.manufacturer-field');
    const unitInput = newRow.querySelector('.unit-field');
    const rateInput = newRow.querySelector('.rate-field');
    const quantityInput = newRow.querySelector('.quantity-field');

    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–±—á–∏—Å–ª–µ–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Å—Ç—ñ
    function updateQuantity() {
      const area = Number("{{ field.area|round(3) }}".replace(',', '.'));  // –ø–ª–æ—â–∞ –ø–æ–ª—è –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è –∑ Jinja
      const rate = parseFloat(rateInput.value);
      if (!isNaN(rate)) {
        const quantity = area * rate;
        quantityInput.value = quantity.toFixed(1); // –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è –¥–æ 1 –∑–Ω–∞–∫–∞
      } else {
        quantityInput.value = '';
      }
    }

    // –ü—Ä–∏ –≤–∏–±–æ—Ä—ñ –ø—Ä–æ–¥—É–∫—Ç—É ‚Äî –æ–Ω–æ–≤–∏—Ç–∏ –≤–∏—Ä–æ–±–Ω–∏–∫–∞, –æ–¥–∏–Ω–∏—Ü—é, –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å
    productSelect.addEventListener('change', function () {
      const selectedOption = productSelect.options[productSelect.selectedIndex];
      manufacturerInput.value = selectedOption.dataset.manufacturer || '';
      unitInput.value = selectedOption.dataset.unit || '';
      updateQuantity();
    });

    // –ü—Ä–∏ –∑–º—ñ–Ω—ñ –Ω–æ—Ä–º–∏ ‚Äî –æ–Ω–æ–≤–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å
    rateInput.addEventListener('input', updateQuantity);

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è –æ–¥—Ä–∞–∑—É
    productSelect.dispatchEvent(new Event('change'));
    rateInput.dispatchEvent(new Event('input'));
  });

  // –í–∏–¥–∞–ª–µ–Ω–Ω—è —Ä—è–¥–∫–∞
  document.querySelector('#treatments-table tbody').addEventListener('click', function (e) {
    if (e.target.classList.contains('delete-row')) {
      e.target.closest('tr').remove();
    }
  });
</script>

  
<!-- –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ø—Ä–∏ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—ñ –Ω–∞–∑–∞–¥ -->
<script>
  document.getElementById('back-button').addEventListener('click', function () {
    const modal = new bootstrap.Modal(document.getElementById('confirmExitModal'));
    modal.show();
  });

  document.getElementById('submit-plan').addEventListener('click', function () {
    document.querySelector('form').submit();
  });

  document.getElementById('exit-without-saving').addEventListener('click', function () {
    const clusterId = "{{ cluster_id }}";
    const companyId = "{{ company.id }}";
    window.location.href = `/new_plans/select_field/${clusterId}/${companyId}`;
  });
</script>

  
{% endblock %}
