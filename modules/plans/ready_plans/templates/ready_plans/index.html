{% extends 'base.html' %}

{% block title %}–ì–æ—Ç–æ–≤—ñ –ø–ª–∞–Ω–∏{% endblock %}
{% block header %}üìã –ì–æ—Ç–æ–≤—ñ –ø–ª–∞–Ω–∏{% endblock %}

{% block content %}
<div class="d-flex justify-content-between mb-3 flex-wrap gap-2">
  <div>
    <a href="{{ url_for('plans.hub') }}" class="btn btn-outline-secondary">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</a>
    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </div>
  <div>
    <form method="get" action="{{ url_for('ready_plans.export_pdf') }}">
      <input type="hidden" name="company_id" value="{{ request.args.get('company_id', '') }}">
      <input type="hidden" name="culture_id" value="{{ request.args.get('culture_id', '') }}">
      <button type="submit" class="btn btn-outline-danger">
        üìÑ –ï–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –≤—Å—ñ –≥–æ—Ç–æ–≤—ñ –ø–ª–∞–Ω–∏ (PDF)
      </button>
    </form>
  </div>
</div>

<!-- üîΩ –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è -->
<form method="GET" class="row g-3 mb-4">
  <div class="col-md-5">
    <select name="company_id" class="form-select">
      <option value="">üîç –§—ñ–ª—å—Ç—Ä –∑–∞ –ø—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ–º</option>
      {% for company in companies %}
        <option value="{{ company.id }}" {% if request.args.get('company_id') == company.id|string %}selected{% endif %}>
          {{ company.name }}
        </option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-5">
    <select name="culture_id" class="form-select">
      <option value="">üåæ –§—ñ–ª—å—Ç—Ä –∑–∞ –∫—É–ª—å—Ç—É—Ä–æ—é</option>
      {% for culture in cultures %}
        <option value="{{ culture.id }}" {% if request.args.get('culture_id') == culture.id|string %}selected{% endif %}>
          {{ culture.name }}
        </option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <button type="submit" class="btn btn-outline-success w-100">üîé –ü–æ—à—É–∫</button>
  </div>
</form>

{# üîΩ –û–∫—Ä–µ–º–∞ —Ñ–æ—Ä–º–∞ –¥–ª—è –º–∞—Å–æ–≤–æ–≥–æ –∑–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è (–±–µ–∑ –≤–∫–ª–∞–¥–µ–Ω—å —É —Ç–∞–±–ª–∏—Ü—é) #}
<form id="bulk-approve-form" method="post" action="{{ url_for('ready_plans.bulk_approve') }}">
  {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
</form>

<table class="table table-bordered table-striped text-center align-middle">
  <thead class="table-success">
    <tr>
      <th>
        <input type="checkbox" id="select-all">
      </th>
      <th>ID</th>
      <th>–ü–æ–ª–µ</th>
      <th>–ü–ª–æ—â–∞</th>
      <th>–ö—É–ª—å—Ç—É—Ä–∞</th>
      <th>–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ</th>
      <th>–î–∞—Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è</th>
      <th>–î—ñ—ó</th>
    </tr>
  </thead>
  <tbody>
    {% for plan in plans %}
    <tr>
      <td>
        {% if not plan.is_approved %}
          {# –ø—Ä–∏–≤‚Äô—è–∑—É—î–º–æ —á–µ–∫–±–æ–∫—Å –¥–æ —Ñ–æ—Ä–º–∏ bulk-approve-form —á–µ—Ä–µ–∑ –∞—Ç—Ä–∏–±—É—Ç form #}
          <input type="checkbox" class="cb-plan" name="plan_ids" value="{{ plan.id }}" form="bulk-approve-form">
        {% endif %}
      </td>
      <td>{{ plan.id }}</td>
      <td>{{ plan.field.name }}</td>
      <td>{{ plan.field.area }} –≥–∞</td>
      <td>{{ plan.field.culture.name if plan.field.culture else '‚Äî' }}</td>
      <td>{{ plan.field.company.name if plan.field.company else '‚Äî' }}</td>
      <td>{{ plan.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
      <td>
        <a href="{{ url_for('ready_plans.view_plan', plan_id=plan.id) }}" class="btn btn-sm btn-outline-primary">üîç</a>
        {% if not plan.is_approved %}
          <a href="{{ url_for('ready_plans.approve_plan', plan_id=plan.id) }}" class="btn btn-sm btn-outline-success">‚úÖ</a>
          <a href="{{ url_for('ready_plans.edit_plan', plan_id=plan.id) }}" class="btn btn-sm btn-outline-warning">‚úèÔ∏è</a>

          {# –æ–∫—Ä–µ–º–∞ —Ñ–æ—Ä–º–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è ‚Äî –ù–ï –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —ñ–Ω—à–æ—ó —Ñ–æ—Ä–º–∏ #}
          <form method="post" action="{{ url_for('ready_plans.delete_plan', plan_id=plan.id) }}" style="display:inline;">
            {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
            <button type="submit" class="btn btn-sm btn-outline-danger"
                    onclick="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –ø–ª–∞–Ω?')">üóëÔ∏è</button>
          </form>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<div class="text-end mt-3">
  <button type="submit" form="bulk-approve-form" class="btn btn-success">‚úÖ –ó–∞—Ç–≤–µ—Ä–¥–∏—Ç–∏ –≤–∏–±—Ä–∞–Ω—ñ</button>
</div>
{% endblock %}

{% block scripts %}
<script>
  // "–í–∏–±—Ä–∞—Ç–∏ –≤—Å—ñ" ‚Äî —Ç–∏—Ü—è—î –ª–∏—à–µ –ø–æ —á–µ–∫–±–æ–∫—Å–∞—Ö, —â–æ –ø–µ—Ä–µ–¥–∞—é—Ç—å—Å—è —É bulk-approve-form
  document.getElementById('select-all')?.addEventListener('change', function () {
    document.querySelectorAll('input.cb-plan').forEach(cb => cb.checked = this.checked);
  });
</script>
{% endblock %}
