{% extends 'base.html' %}
{% block title %}–ù–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è ‚Äî –∂—É—Ä–Ω–∞–ª{% endblock %}
{% block header %}üßæ –ñ—É—Ä–Ω–∞–ª –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω—å{% endblock %}

{% block content %}
<div class="d-flex justify-content-between mb-3">
  <div>
    <a href="{{ url_for('warehouse.index') }}" class="btn btn-outline-secondary">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</a>
    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  </div>
</div>

<div class="container">
  <!-- –û—á—ñ–∫—É—é—Ç—å –æ–ø—Ä–∏–±—É—Ç–∫—É–≤–∞–Ω–Ω—è -->
  <h5 class="text-success mb-3">–û—á—ñ–∫—É—é—Ç—å –æ–ø—Ä–∏–±—É—Ç–∫—É–≤–∞–Ω–Ω—è</h5>
  {% if not pending %}
    <div class="alert alert-info">–ù–µ–º–∞—î –æ–ø–ª–∞—á–µ–Ω–∏—Ö –∑–∞—è–≤–æ–∫, —è–∫—ñ —á–µ–∫–∞—é—Ç—å –Ω–∞ –æ–ø—Ä–∏–±—É—Ç–∫—É–≤–∞–Ω–Ω—è.</div>
  {% else %}
    <table class="table table-striped table-hover table-bordered align-middle text-center">
      <thead class="table-success">
        <tr>
          <th style="width:80px;">‚Ññ</th>
          <th style="width:160px;">–î–∞—Ç–∞</th>
          <th class="text-start">–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ (—Å–ø–æ–∂–∏–≤–∞—á)</th>
          <th class="text-start">–ü–ª–∞—Ç–Ω–∏–∫–∏</th>
          <th style="width:110px;">–ü–æ–∑–∏—Ü—ñ–π</th>
          <th style="width:160px;">–°—Ç–∞–Ω –ø–æ—Å—Ç–∞—á–∞–Ω–Ω—è</th>
          <th style="width:170px;">–î—ñ—ó</th>
        </tr>
      </thead>
      <tbody>
        {% for r in pending %}
          {% set collapse_id = 'inbox_' ~ r['inbox'].id %}
          <tr>
            <td>{{ r['inbox'].id }}</td>
            <td>{{ r['inbox'].created_at.strftime('%Y-%m-%d %H:%M') if r['inbox'].created_at else '‚Äî' }}</td>
            <td class="text-start">{{ r['company_name'] or '‚Äî' }}</td>
            <td class="text-start">{{ r['payers_summary'] }}</td>
            <td>{{ r['rows_count'] }}</td>
            <td>
              {% if r['fulfillment'] == '–ß–∞—Å—Ç–∫–æ–≤–æ –≤–∏–∫–æ–Ω–∞–Ω–æ' %}
                <span class="badge bg-warning text-dark">{{ r['fulfillment'] }}</span>
              {% else %}
                <span class="badge bg-secondary">{{ r['fulfillment'] }}</span>
              {% endif %}
            </td>
            <td>
              <div class="d-flex gap-2 justify-content-center">
                <button class="btn btn-sm btn-outline-success"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#{{ collapse_id }}">
                  –ü–æ–∫–∞–∑–∞—Ç–∏
                </button>
                <a href="{{ url_for('warehouse.receive', inbox_id=r['inbox'].id) }}" class="btn btn-sm btn-primary">
                  ‚úÖ –ü—Ä–∏–π–Ω—è—Ç–∏
                </a>
              </div>
            </td>
          </tr>
          <tr class="collapse" id="{{ collapse_id }}">
            <td colspan="7" class="p-0">
              <div class="p-3 text-start">
                <strong>–ü–æ–∑–∏—Ü—ñ—ó –∑–∞—è–≤–∫–∏:</strong>
                <div class="table-responsive mt-2">
                  <table class="table table-sm table-bordered align-middle">
                    <thead class="table-light">
                      <tr>
                        <th class="text-center" style="width:60px;">#</th>
                        <th>–ü—Ä–æ–¥—É–∫—Ç</th>
                        <th>–¢–∞—Ä–∞</th>
                        <th class="text-end" style="width:120px;">–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
                        <th>–í–∏—Ä–æ–±–Ω–∏–∫</th>
                        <th>–ü–ª–∞—Ç–Ω–∏–∫</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for it in r['items'] %}
                        <tr>
                          <td class="text-center">{{ loop.index }}</td>
                          <td>{{ it.product_name }}</td>
                          <td>{{ it.package }}</td>
                          <td class="text-end">{{ '%.3f'|format(it.qty) }}</td>
                          <td>{{ it.manufacturer_name }}</td>
                          <td>{{ it.payer_name }}</td>
                        </tr>
                      {% else %}
                        <tr><td colspan="6" class="text-muted text-center">–†—è–¥–∫—ñ–≤ –Ω–µ–º–∞—î</td></tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

  <!-- –Ü—Å—Ç–æ—Ä—ñ—è –æ–ø—Ä–∏–±—É—Ç–∫—É–≤–∞–Ω—å -->
  <h5 class="text-success mt-4 mb-3">–Ü—Å—Ç–æ—Ä—ñ—è –æ–ø—Ä–∏–±—É—Ç–∫—É–≤–∞–Ω—å</h5>
  <table class="table table-striped table-hover table-bordered text-center align-middle">
    <thead class="table-success">
      <tr>
        <th>–î–∞—Ç–∞</th>
        <th class="text-start">–ü—Ä–æ–¥—É–∫—Ç</th>
        <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
        <th>–û–¥.</th>
        <th>–î–∂–µ—Ä–µ–ª–æ</th>
      </tr>
    </thead>
    <tbody>
      {% for r in history %}
        <tr>
          <td>{{ r.tx_date.strftime('%Y-%m-%d %H:%M') }}</td>
          <td class="text-start">{{ r.product_name }}</td>
          <td>{{ '%.3f'|format(r.qty) }}</td>
          <td>{{ r.unit_text }}</td>
          <td>
            {% if r.source_kind == 'payment_inbox' and r.source_id %}
              <span class="text-muted">PaymentInbox #{{ r.source_id }}</span>
            {% else %}
              <span class="text-muted">‚Äî</span>
            {% endif %}
          </td>
        </tr>
      {% else %}
        <tr><td colspan="5" class="text-muted">–ó–∞–ø–∏—Å—ñ–≤ –ø—Ä–æ –æ–ø—Ä–∏–±—É—Ç–∫—É–≤–∞–Ω–Ω—è –Ω–µ–º–∞—î</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
