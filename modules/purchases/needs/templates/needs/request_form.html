{% extends 'base.html' %}
{% block title %}–ó–∞—è–≤–∫–∞ –Ω–∞ –∑–∞–∫—É–ø—ñ–≤–ª—é{% endblock %}
{% block header %}üßæ –ó–∞—è–≤–∫–∞ –Ω–∞ –∑–∞–∫—É–ø—ñ–≤–ª—é{% endblock %}

{% block content %}
<div class="d-flex justify-content-between mb-3">
  <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
  <div class="d-flex gap-2">
    <a href="{{ url_for('requests.index') }}" class="btn btn-outline-secondary">–ù–∞–∑–∞–¥</a>
  </div>
</div>

{# fallback: —è–∫—â–æ selection_enabled –Ω–µ –ø–µ—Ä–µ–¥–∞–ª–∏ –∑ —Ä–æ—É—Ç—É, –≤–≤–∞–∂–∞—î–º–æ —â–æ –≤–æ–Ω–æ –µ–∫–≤—ñ–≤–∞–ª–µ–Ω—Ç–Ω–µ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ company_id #}
{% set selection_enabled = selection_enabled if selection_enabled is defined else (company_id is not none and company_id != '') %}

{% if not selection_enabled %}
  <div class="alert alert-info">
    –°–ø–∏—Å–æ–∫ –ø–æ–∫–∞–∑–∞–Ω–æ –¥–ª—è <strong>–≤—Å—ñ—Ö –ø—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤</strong>. –û–±–µ—Ä—ñ—Ç—å <strong>–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ (—Å–ø–æ–∂–∏–≤–∞—á–∞)</strong> —É —Ñ—ñ–ª—å—Ç—Ä—ñ, —â–æ–±
    –∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏ –≤–∏–±—ñ—Ä –ø–æ–∑–∏—Ü—ñ–π —Ç–∞ —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è –∑–∞—è–≤–∫–∏.
  </div>
{% else %}
  <div class="alert alert-info">
    <strong>–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ:</strong>
    {{ (companies | selectattr('id', 'equalto', company_id) | list | first).name if company_id else '‚Äî' }}
  </div>
{% endif %}

<form method="GET" action="{{ url_for('needs.request_form') }}" class="row g-2 align-items-end mb-3">
  <div class="col-md-4">
    <label class="form-label">–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ (—Å–ø–æ–∂–∏–≤–∞—á)</label>
    <select name="company_id" class="form-select">
      <option value="">‚Äî –£—Å—ñ ‚Äî</option>
      {% for c in companies %}
        <option value="{{ c.id }}" {{ 'selected' if company_id==c.id else '' }}>{{ c.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-4">
    <label class="form-label">–ü—Ä–æ–¥—É–∫—Ç (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)</label>
    <select name="product_id" class="form-select">
      <option value="">‚Äî –£—Å—ñ ‚Äî</option>
      {% for p in products %}
        <option value="{{ p.id }}" {{ 'selected' if product_id==p.id else '' }}>{{ p.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">–ü–ª–∞—Ç–Ω–∏–∫ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)</label>
    <select name="payer_id" class="form-select">
      <option value="">‚Äî –£—Å—ñ ‚Äî</option>
      {% for p in payers %}
        <option value="{{ p.id }}" {{ 'selected' if payer_id==p.id else '' }}>{{ p.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-1 d-grid">
    <button class="btn btn-success">–ü–æ–∫–∞–∑–∞—Ç–∏</button>
  </div>
</form>

<form method="POST" action="{{ url_for('needs.request_preview') }}">
  <input type="hidden" name="company_id" value="{{ company_id or '' }}">
  <input type="hidden" name="product_id" value="{{ product_id or '' }}">
  <input type="hidden" name="payer_id" value="{{ payer_id or '' }}">

  <table class="table table-bordered align-middle text-center">
    <thead class="table-success">
      <tr>
        <th style="width:52px;">‚úî</th>
        <th class="text-start">–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ</th>
        <th class="text-start">–ü—Ä–æ–¥—É–∫—Ç</th>
        <th class="text-start">–¢–∞—Ä–∞</th>
        <th>–û–¥.</th>
        <th class="text-start">–ü–ª–∞—Ç–Ω–∏–∫</th>
        <th class="text-end" style="width:160px;">–ó–∞–ª–∏—à–æ–∫ –¥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</th>
        <th style="width:180px;">–ó–∞–º–æ–≤–∏—Ç–∏</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
        {% set pid = r.product_id %}
        {% set pay = r.payer_id if r.payer_id is not none else 0 %}
        {% set avail = r.available or 0 %}
        <tr class="{{ 'table-light' if avail <= 0 }}">
          <td>
            <input class="form-check-input" type="checkbox"
                   name="selected" value="{{ pid }}::{{ pay }}"
                   {{ 'disabled' if (avail <= 0 or not selection_enabled) }}>
          </td>
          <td class="text-start">{{ r.company_name or '‚Äî' }}</td>
          <td class="text-start">{{ r.product_name or ('#' ~ pid) }}</td>
          <td class="text-start">{{ r.package or '‚Äî' }}</td>
          <td>{{ r.unit_name or '‚Äî' }}</td>
          <td class="text-start">{{ r.payer_name or '‚Äî' }}</td>
          <td class="text-end">{{ '%.3f'|format(avail) }}</td>
          <td>
            <input class="form-control" type="number" step="0.001" min="0"
                   max="{{ avail }}" value="{{ '%.3f'|format(avail) }}"
                   name="qty_{{ pid }}_{{ pay }}"
                   {{ 'disabled' if (avail <= 0 or not selection_enabled) }}>
          </td>
        </tr>
      {% else %}
        <tr><td colspan="8" class="text-muted">–ù–µ–º–∞—î –ø–æ–∑–∏—Ü—ñ–π –∑–∞ –æ–±—Ä–∞–Ω–∏–º–∏ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <button type="submit" class="btn btn-success"
          {% if not rows or not selection_enabled %}disabled title="–û–±–µ—Ä—ñ—Ç—å –ø—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ, —â–æ–± —Å—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –∑–∞—è–≤–∫—É"{% endif %}>
    –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥
  </button>
</form>
{% endblock %}
