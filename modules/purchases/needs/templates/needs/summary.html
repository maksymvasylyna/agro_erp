{% extends 'base.html' %}

{% block title %}–ó–≤–µ–¥–µ–Ω–∞ –ø–æ—Ç—Ä–µ–±–∞{% endblock %}
{% block header %}üßÆ –ó–≤–µ–¥–µ–Ω–∞ –ø–æ—Ç—Ä–µ–±–∞ (–∑–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω—ñ –ø–ª–∞–Ω–∏){% endblock %}

{% block content %}

{# 1-–π —Ä—è–¥: –ù–∞–∑–∞–¥ / –î–æ–¥–æ–º—É #}
<div class="d-flex justify-content-between mb-3">
  <a href="{{ url_for('purchases.index') }}" class="btn btn-outline-secondary">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</a>
  <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
</div>

{# 2-–π —Ä—è–¥: –§—ñ–ª—å—Ç—Ä–∏ + '–§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏' #}
<form method="get" action="{{ url_for('needs.summary') }}" class="mb-3">
  <div class="row g-2 align-items-end">
    <div class="col-12 col-md-4">
      <label class="form-label small fw-semibold mb-1" for="company">–ü–æ –ø—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤—É</label>
      <select class="form-select" name="company_id" id="company">
        <option value="">‚Äî –£—Å—ñ ‚Äî</option>
        {% for c in companies %}
          <option value="{{ c.id }}" {% if company_id and company_id == c.id %}selected{% endif %}>{{ c.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-12 col-md-4">
      <label class="form-label small fw-semibold mb-1" for="culture">–ü–æ –∫—É–ª—å—Ç—É—Ä—ñ</label>
      <select class="form-select" name="culture_id" id="culture">
        <option value="">‚Äî –£—Å—ñ ‚Äî</option>
        {% for cu in cultures %}
          <option value="{{ cu.id }}" {% if culture_id and culture_id == cu.id %}selected{% endif %}>{{ cu.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-12 col-md-4">
      <label class="form-label small fw-semibold mb-1" for="product">–ü–æ –ø—Ä–æ–¥—É–∫—Ç—É</label>
      <select class="form-select" name="product_id" id="product">
        <option value="">‚Äî –£—Å—ñ ‚Äî</option>
        {% for p in products %}
          <option value="{{ p.id }}" {% if product_id and product_id == p.id %}selected{% endif %}>{{ p.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-12 col-md-auto">
      <button type="submit" class="btn btn-primary mt-2 mt-md-0">üîé –§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏</button>
    </div>
  </div>
</form>

{# 3-–π —Ä—è–¥: '–û–Ω–æ–≤–∏—Ç–∏ –∑ –ø–ª–∞–Ω—ñ–≤' + '–ï–∫—Å–ø–æ—Ä—Ç PDF' #}
<div class="d-flex gap-2 mb-3">
  <form method="post" action="{{ url_for('needs.summary_sync') }}">
    {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
    <input type="hidden" name="company_id" value="{{ company_id or '' }}">
    <input type="hidden" name="culture_id" value="{{ culture_id or '' }}">
    <input type="hidden" name="product_id" value="{{ product_id or '' }}">
    <button type="submit" class="btn btn-outline-success">üîÑ –û–Ω–æ–≤–∏—Ç–∏ –∑ –ø–ª–∞–Ω—ñ–≤</button>
  </form>

  <form method="get" action="{{ url_for('needs.summary_export_pdf') }}">
    <input type="hidden" name="company_id" value="{{ company_id or '' }}">
    <input type="hidden" name="culture_id" value="{{ culture_id or '' }}">
    <input type="hidden" name="product_id" value="{{ product_id or '' }}">
    <button type="submit" class="btn btn-outline-danger">üìÑ –ï–∫—Å–ø–æ—Ä—Ç (PDF)</button>
  </form>
</div>

<table class="table table-sm align-middle">
  <thead>
    <tr>
      <th>–ü—Ä–æ–¥—É–∫—Ç</th>
      <th>–ö—É–ª—å—Ç—É—Ä–∞</th>
      <th>–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ</th>
      <th class="text-end">–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
    </tr>
  </thead>
  <tbody>
    {% for r in data %}
      <tr>
        <td>{{ r.product_name }}</td>
        <td>{{ r.culture_name }}</td>
        <td>{{ r.company_name }}</td>
        <td class="text-end">{{ '%.3f'|format(r.qty) }}</td>
      </tr>
    {% else %}
      <tr>
        <td colspan="4" class="text-center text-muted">–î–∞–Ω–∏—Ö –Ω–µ–º–∞—î</td>
      </tr>
    {% endfor %}
  </tbody>
</table>

{% endblock %}
