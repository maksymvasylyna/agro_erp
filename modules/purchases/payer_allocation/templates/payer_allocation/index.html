{% extends 'base.html' %}

{% block title %}–†–æ–∑–ø–æ–¥—ñ–ª –º—ñ–∂ –ü–ª–∞—Ç–Ω–∏–∫–∞–º–∏{% endblock %}
{% block header %}üí≥ –†–æ–∑–ø–æ–¥—ñ–ª –º—ñ–∂ –ü–ª–∞—Ç–Ω–∏–∫–∞–º–∏{% endblock %}

{% block content %}

{# ==== 1-–π —Ä—è–¥: –ù–∞–∑–∞–¥ ‚Äî –î–æ–¥–æ–º—É ==== #}
<div class="d-flex justify-content-between align-items-center mb-3">
  <a href="{{ url_for('purchases.index') }}" class="btn btn-outline-secondary">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</a>
  <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
</div>

{# ==== 2-–π —Ä—è–¥: —É—Å—ñ —Ñ—ñ–ª—å—Ç—Ä–∏ + –§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏ ==== #}
<form action="{{ url_for('payer_allocation.index') }}" method="get" class="mb-3">
  {{ form.hidden_tag() }}
  <div class="row g-2 align-items-end">
    <div class="col-12 col-md-3">
      <label for="{{ form.company.id }}" class="form-label small fw-semibold mb-1">–ü–æ –ø—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤—É</label>
      {{ form.company(class="form-select") }}
    </div>
    <div class="col-12 col-md-3">
      <label for="{{ form.product.id }}" class="form-label small fw-semibold mb-1">–ü–æ –ø—Ä–æ–¥—É–∫—Ç—É</label>
      {{ form.product(class="form-select") }}
    </div>
    <div class="col-12 col-md-3">
      <label for="{{ form.manufacturer.id }}" class="form-label small fw-semibold mb-1">–ü–æ –≤–∏—Ä–æ–±–Ω–∏–∫—É</label>
      {{ form.manufacturer(class="form-select") }}
    </div>
    <div class="col-12 col-md-3">
      <label for="{{ form.payer.id }}" class="form-label small fw-semibold mb-1">–ü–æ –ø–æ–∫—É–ø—Ü—é</label>
      {{ form.payer(class="form-select") }}
    </div>
    <div class="col-12 col-md-auto">
      {{ form.submit(class="btn btn-primary mt-2 mt-md-0") }}
    </div>
  </div>
</form>

{# ==== 3-–π —Ä—è–¥: –ü–æ–∫—É–ø–µ—Ü—å + –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ + –û–Ω–æ–≤–∏—Ç–∏ –∑ –ø–ª–∞–Ω—ñ–≤ + –ï–∫—Å–ø–æ—Ä—Ç PDF ==== #}
<div class="row g-2 align-items-end mb-3">
  <div class="col-12 col-md-8">
    <form id="bulk-form" action="{{ url_for('payer_allocation.bulk_assign') }}" method="post" class="row g-2 align-items-end">
      {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
      <input type="hidden" name="ids" id="bulk-ids" />
      <div class="col-12 col-md-6">
        <label for="{{ bulk_form.payer.id }}" class="form-label small fw-semibold mb-1">–ü–æ–∫—É–ø–µ—Ü—å –¥–ª—è –æ–±—Ä–∞–Ω–∏—Ö —Ä—è–¥–∫—ñ–≤</label>
        {{ bulk_form.payer(class="form-select") }}
      </div>
      <div class="col-12 col-md-auto">
        {{ bulk_form.assign(class="btn btn-success mt-2 mt-md-0") }}
      </div>
    </form>
  </div>

  <div class="col-12 col-md-4">
    <div class="d-flex justify-content-md-end gap-2">
      <form action="{{ url_for('payer_allocation.sync') }}" method="post">
        {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
        <button type="submit" class="btn btn-outline-success mt-2 mt-md-0">üîÑ –û–Ω–æ–≤–∏—Ç–∏ –∑ –ø–ª–∞–Ω—ñ–≤</button>
      </form>

      {# GET-—Ñ–æ—Ä–º–∞ –Ω–∞ –µ–∫—Å–ø–æ—Ä—Ç, –ø–µ—Ä–µ–¥–∞—î –ø–æ—Ç–æ—á–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏ –∑ request.args #}
      <form action="{{ url_for('payer_allocation.export_pdf') }}" method="get">
        <input type="hidden" name="company" value="{{ request.args.get('company') or '' }}">
        <input type="hidden" name="product" value="{{ request.args.get('product') or '' }}">
        <input type="hidden" name="manufacturer" value="{{ request.args.get('manufacturer') or '' }}">
        <input type="hidden" name="payer" value="{{ request.args.get('payer') or '' }}">
        <button type="submit" class="btn btn-outline-danger mt-2 mt-md-0">üìÑ –ï–∫—Å–ø–æ—Ä—Ç (PDF)</button>
      </form>
    </div>
  </div>
</div>

<table class="table table-sm align-middle">
  <thead>
    <tr>
      <th style="width:2.5rem;"><input type="checkbox" id="check-all"></th>
      <th>–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ</th>
      <th>–ü–æ–ª–µ</th>
      <th>–ü—Ä–æ–¥—É–∫—Ç</th>
      <th>–í–∏—Ä–æ–±–Ω–∏–∫</th>
      <th class="text-end">–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
      <th>–û–¥–∏–Ω–∏—Ü—è</th>
      <th>–ü–æ–∫—É–ø–µ—Ü—å</th>
    </tr>
  </thead>
  <tbody>
  {% for row in rows %}
    <tr>
      <td><input type="checkbox" class="check-row" value="{{ row.id }}"></td>
      <td>{{ row.company.name if row.company else '‚Äî' }}</td>
      <td>{{ row.field.name if row.field else '‚Äî' }}</td>
      <td>{{ row.product.name if row.product else '‚Äî' }}</td>
      <td>{{ row.manufacturer.name if row.manufacturer else '‚Äî' }}</td>
      <td class="text-end">{{ row.qty }}</td>
      <td>{{ row.unit.name if row.unit else '‚Äî' }}</td>
      <td>{{ row.payer.name if row.payer else '‚Äî' }}</td>
    </tr>
  {% else %}
    <tr><td colspan="8" class="text-center text-muted">–î–∞–Ω–∏—Ö –Ω–µ–º–∞—î</td></tr>
  {% endfor %}
  </tbody>
</table>
{% endblock %}

{% block scripts %}
<script>
// –í–∏–±—Ä–∞—Ç–∏ –≤—Å—ñ
document.getElementById('check-all')?.addEventListener('change', function(e){
  document.querySelectorAll('.check-row').forEach(cb => cb.checked = e.target.checked);
});

// –ó—ñ–±—Ä–∞—Ç–∏ ID –ø–µ—Ä–µ–¥ —Å–∞–±–º—ñ—Ç–æ–º –º–∞—Å–æ–≤–æ—ó —Ñ–æ—Ä–º–∏
document.getElementById('bulk-form')?.addEventListener('submit', function(e){
  const ids = Array.from(document.querySelectorAll('.check-row:checked')).map(cb => cb.value);
  if (!ids.length) {
    e.preventDefault();
    alert('–û–±–µ—Ä—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–∏–Ω —Ä—è–¥–æ–∫.');
    return false;
  }
  document.getElementById('bulk-ids').value = ids.join(',');
});
</script>
{% endblock %}
