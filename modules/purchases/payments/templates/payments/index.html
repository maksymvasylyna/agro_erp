{% extends 'base.html' %}
{% block title %}{{ title or '–ü—Ä–æ–ø–ª–∞—Ç–∏ ‚Äî –≤—Ö—ñ–¥–Ω—ñ –∑–∞—è–≤–∫–∏' }}{% endblock %}
{% block header %}{{ header or 'üí≥ –ü—Ä–æ–ø–ª–∞—Ç–∏ ‚Äî –≤—Ö—ñ–¥–Ω—ñ –∑–∞—è–≤–∫–∏' }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between mb-3">
  <div class="d-flex gap-2">
    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
    <a href="{{ url_for('purchases.index') }}" class="btn btn-outline-secondary">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</a>
  </div>
  <form method="post" action="{{ url_for('payments.clear') }}" onsubmit="return confirm('–¢–æ—á–Ω–æ –æ—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ –∑–∞—è–≤–∫–∏? –¶–µ –Ω–µ–∑–≤–æ—Ä–æ—Ç–Ω–æ.');">
    <button type="submit" class="btn btn-outline-danger">‚ôªÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ</button>
  </form>
</div>

{% if not items %}
  <div class="alert alert-info mb-3">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –≤—Ö—ñ–¥–Ω–∏—Ö –∑–∞—è–≤–æ–∫.</div>
{% else %}
  <table class="table table-striped table-hover table-bordered align-middle text-center">
    <thead class="table-success">
      <tr>
        <th style="width:80px;">‚Ññ</th>
        <th style="width:160px;">–î–∞—Ç–∞</th>
        <th class="text-start">–ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ (—Å–ø–æ–∂–∏–≤–∞—á)</th>
        <th class="text-start">–ü–ª–∞—Ç–Ω–∏–∫–∏</th>
        <th style="width:90px;">–ü–æ–∑–∏—Ü—ñ–π</th>
        <th style="width:120px;">–°—Ç–∞—Ç—É—Å</th>
        <th style="width:220px;">–î—ñ—ó</th>
      </tr>
    </thead>
    <tbody>
      {% for r in items %}
        {% set collapse_id = 'inbox_' ~ r.id %}
        <tr>
          <td>{{ r.id }}</td>
          <td>{{ r.created_at.strftime('%Y-%m-%d %H:%M') if r.created_at else '‚Äî' }}</td>
          <td class="text-start">{{ r.company_name or (r.company.name if r.company else '‚Äî') }}</td>
          <td class="text-start">{{ r.payers_summary or '‚Äî' }}</td>
          <td>{{ r.rows_count or (r.items|length) }}</td>
          <td>{{ r.status or 'submitted' }}</td>
          <td>
            <div class="d-flex gap-2 justify-content-center">
              <button class="btn btn-sm btn-outline-success"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#{{ collapse_id }}"
                      aria-expanded="false"
                      aria-controls="{{ collapse_id }}">
                –ü–æ–∫–∞–∑–∞—Ç–∏
              </button>
              <form method="post" action="{{ url_for('payments.delete', inbox_id=r.id) }}"
                    onsubmit="return confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞—è–≤–∫—É #{{ r.id }}? –î—ñ—é –Ω–µ –º–æ–∂–Ω–∞ —Å–∫–∞—Å—É–≤–∞—Ç–∏.');">
                <button type="submit" class="btn btn-sm btn-outline-danger">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>
              </form>
            </div>
          </td>
        </tr>
        <tr class="collapse" id="{{ collapse_id }}">
          <td colspan="7" class="p-0">
            <div class="p-3 text-start">
              <strong>–ü–æ–∑–∏—Ü—ñ—ó –∑–∞—è–≤–∫–∏:</strong>
              <div class="table-responsive mt-2">
                <table class="table table-sm table-bordered align-middle">
                  <thead class="table-light">
                    <tr>
                      <th class="text-center" style="width:60px;">#</th>
                      <th>–ü—Ä–æ–¥—É–∫—Ç</th>
                      <th>–¢–∞—Ä–∞</th>
                      <th class="text-end" style="width:120px;">–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
                      <th>–í–∏—Ä–æ–±–Ω–∏–∫</th>
                      <th>–ü–ª–∞—Ç–Ω–∏–∫</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for it in r.items %}
                      <tr>
                        <td class="text-center">{{ loop.index }}</td>
                        <td>{{ it.product_name or ('#' ~ it.product_id) }}</td>
                        <td>{{ it.package or '‚Äî' }}</td>
                        <td class="text-end">{{ it.qty is defined and ('%.3f'|format(it.qty)) or '‚Äî' }}</td>
                        <td>{{ it.manufacturer_name or '‚Äî' }}</td>
                        <td>{{ it.payer_name or '‚Äî' }}</td>
                      </tr>
                    {% else %}
                      <tr><td colspan="6" class="text-muted text-center">–†—è–¥–∫—ñ–≤ –Ω–µ–º–∞—î</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% endif %}
{% endblock %}
